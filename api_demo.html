<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatterbox TTS API Demo</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-container input[type="range"] {
      flex: 1;
    }

    .slider-value {
      min-width: 60px;
      text-align: center;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 3px;
      font-family: monospace;
    }

    .advanced-options {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 5px;
      background: #fafafa;
      margin: 15px 0;
    }

    .advanced-toggle {
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .advanced-toggle:hover {
      text-decoration: underline;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .audio-output {
      margin-top: 20px;
      padding: 15px;
      background: #e8f4f8;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .file-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .audio-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }

    .audio-file-info {
      flex: 1;
      margin-right: 10px;
    }

    .audio-file-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 2px;
    }

    .audio-file-meta {
      font-size: 11px;
      color: #666;
    }

    .audio-file-actions {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
    }

    .btn-play {
      background: #28a745;
      color: white;
    }

    .btn-play:hover {
      background: #218838;
    }

    .btn-download {
      background: #17a2b8;
      color: white;
    }

    .btn-download:hover {
      background: #138496;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    .empty-library {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üé§ Chatterbox TTS API Demo</h1>

    <form id="ttsForm">
      <div class="form-group">
        <label for="text">Text to Synthesize (max 300 chars):</label>
        <textarea id="text" name="text" placeholder="Enter the text you want to convert to speech..."
          maxlength="300">Now let's make my mum's favourite. So three mars bars into the pan. Then we add the tuna and just stir for a bit, just let the chocolate and fish infuse. A sprinkle of olive oil and some tomato ketchup. Now smell that. Oh boy this is going to be incredible.</textarea>
        <div class="file-info">
          <span id="charCount">0</span> / 300 characters
        </div>
      </div>

      <div class="form-group">
        <label for="existingReference">Reference Audio (for voice cloning):</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="existingReference" name="reference_audio_file" style="flex: 1;">
            <option value="">Choose existing reference audio...</option>
          </select>
          <button type="button" class="btn-secondary" onclick="deleteReferenceAudio()"
            style="padding: 8px 12px; font-size: 12px; white-space: nowrap;">
            üóëÔ∏è Delete
          </button>
        </div>
        <div class="file-info">Select from available reference audio files, or upload a new one below</div>
      </div>

      <div class="form-group">
        <label for="referenceAudio">Upload New Reference Audio:</label>
        <input type="file" id="referenceAudio" name="reference_audio" accept="audio/*">
        <div class="file-info">
          Upload an audio file to clone its voice characteristics
          <br>
          <button type="button" class="btn-secondary" onclick="uploadReferenceAudio()"
            style="margin-top: 5px; font-size: 12px; padding: 5px 10px;">
            ÔøΩ Save to Reference Library
          </button>
        </div>
      </div>

      <div class="form-group">
        <label for="exaggeration">Emotion Exaggeration:</label>
        <div class="slider-container">
          <input type="range" id="exaggeration" name="exaggeration" min="0.25" max="2.0" step="0.05" value="0.5">
          <span class="slider-value" id="exaggerationValue">0.5</span>
        </div>
        <div class="file-info">0.5 = neutral, higher = more dramatic</div>
      </div>

      <div class="form-group">
        <label for="cfgWeight">CFG/Pace:</label>
        <div class="slider-container">
          <input type="range" id="cfgWeight" name="cfg_weight" min="0.0" max="1.0" step="0.05" value="0.5">
          <span class="slider-value" id="cfgWeightValue">0.5</span>
        </div>
      </div>

      <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
        <span id="advancedText">‚ñ∂ Show Advanced Options</span>
      </button>

      <div id="advancedOptions" class="advanced-options hidden">
        <div class="form-group">
          <label for="seed">Random Seed (0 for random):</label>
          <input type="number" id="seed" name="seed" value="0" min="0">
        </div>

        <div class="form-group">
          <label for="temperature">Temperature:</label>
          <div class="slider-container">
            <input type="range" id="temperature" name="temperature" min="0.05" max="5.0" step="0.05" value="0.8">
            <span class="slider-value" id="temperatureValue">0.8</span>
          </div>
        </div>

        <div class="form-group">
          <label for="minP">Min-P:</label>
          <div class="slider-container">
            <input type="range" id="minP" name="min_p" min="0.00" max="1.00" step="0.01" value="0.05">
            <span class="slider-value" id="minPValue">0.05</span>
          </div>
        </div>

        <div class="form-group">
          <label for="topP">Top-P:</label>
          <div class="slider-container">
            <input type="range" id="topP" name="top_p" min="0.00" max="1.00" step="0.01" value="1.00">
            <span class="slider-value" id="topPValue">1.00</span>
          </div>
        </div>

        <div class="form-group">
          <label for="repetitionPenalty">Repetition Penalty:</label>
          <div class="slider-container">
            <input type="range" id="repetitionPenalty" name="repetition_penalty" min="1.00" max="2.00" step="0.1"
              value="1.2">
            <span class="slider-value" id="repetitionPenaltyValue">1.2</span>
          </div>
        </div>

        <div class="form-group">
          <label for="outputFormat">Output Format:</label>
          <select id="outputFormat" name="output_format">
            <option value="wav">WAV (recommended)</option>
            <option value="mp3">MP3</option>
            <option value="flac">FLAC</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn-primary" onclick="generateAudio('stream')">
          üéµ Generate & Play
        </button>
        <button type="button" class="btn-secondary" onclick="generateAudio('download')">
          üíæ Generate & Download
        </button>
      </div>
    </form>

    <div id="status" class="status hidden"></div>

    <div id="audioOutput" class="audio-output hidden">
      <h3>Generated Audio:</h3>
      <audio id="audioPlayer" controls style="width: 100%;"></audio>
      <div style="margin-top: 10px;">
        <button type="button" class="btn-secondary" onclick="downloadLastAudio()">
          üíæ Download Audio File
        </button>
      </div>
    </div>

    <!-- Generated Audio Files Library -->
    <div id="audioLibrary" class="audio-output" style="margin-top: 30px;">
      <h3>üìÅ Generated Audio Library</h3>
      <div style="margin-bottom: 15px;">
        <button type="button" class="btn-secondary" onclick="loadOutputAudioFiles()"
          style="font-size: 12px; padding: 5px 10px;">
          üîÑ Refresh List
        </button>
        <span id="audioLibraryCount" style="margin-left: 10px; color: #666; font-size: 12px;"></span>
      </div>
      <div id="audioFilesList">
        <!-- Audio files will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let lastAudioBlob = null;
    let lastFileName = 'generated_audio.wav';

    // Update slider values
    document.querySelectorAll( 'input[type="range"]' ).forEach( slider => {
      const valueSpan = document.getElementById( slider.id + 'Value' );
      slider.addEventListener( 'input', function () {
        valueSpan.textContent = this.value;
      } );
    } );

    // Update character count
    document.getElementById( 'text' ).addEventListener( 'input', function () {
      document.getElementById( 'charCount' ).textContent = this.value.length;
    } );

    function toggleAdvanced() {
      const options = document.getElementById( 'advancedOptions' );
      const text = document.getElementById( 'advancedText' );

      if ( options.classList.contains( 'hidden' ) ) {
        options.classList.remove( 'hidden' );
        text.textContent = '‚ñº Hide Advanced Options';
      } else {
        options.classList.add( 'hidden' );
        text.textContent = '‚ñ∂ Show Advanced Options';
      }
    }

    function showStatus( message, type ) {
      const status = document.getElementById( 'status' );
      status.textContent = message;
      status.className = `status ${type}`;
      status.classList.remove( 'hidden' );
    }

    function hideStatus() {
      document.getElementById( 'status' ).classList.add( 'hidden' );
    }

    async function generateAudio( mode ) {
      const form = document.getElementById( 'ttsForm' );
      const formData = new FormData();

      // Add all form fields except reference audio related ones
      const formElements = form.elements;
      for ( let i = 0; i < formElements.length; i++ ) {
        const element = formElements[ i ];
        if ( element.name && element.name !== 'reference_audio' && element.name !== 'reference_audio_file' ) {
          if ( element.type === 'file' ) {
            // Skip file inputs that aren't for reference audio
            continue;
          } else {
            formData.append( element.name, element.value );
          }
        }
      }

      // Handle reference audio - check both dropdown and upload
      const existingReference = document.getElementById( 'existingReference' ).value;
      const referenceAudioInput = document.getElementById( 'referenceAudio' );

      // Priority: uploaded file takes precedence over selected existing file
      if ( referenceAudioInput.files.length > 0 ) {
        formData.append( 'reference_audio', referenceAudioInput.files[ 0 ] );
      } else if ( existingReference ) {
        formData.append( 'reference_audio_file', existingReference );
      }

      const text = formData.get( 'text' );
      if ( !text.trim() ) {
        showStatus( 'Please enter some text to synthesize.', 'error' );
        return;
      }

      // Disable buttons
      document.querySelectorAll( 'button' ).forEach( btn => btn.disabled = true );

      showStatus( 'Generating audio...', 'loading' );

      try {
        const endpoint = mode === 'stream' ? '/generate/stream' : '/generate';
        const url = `${API_BASE_URL}${endpoint}`;

        const response = await fetch( url, {
          method: 'POST',
          body: formData
        } );

        if ( !response.ok ) {
          const errorText = await response.text();
          throw new Error( `HTTP ${response.status}: ${errorText}` );
        }

        const blob = await response.blob();
        lastAudioBlob = blob;

        // Get filename from Content-Disposition header or use default
        const contentDisposition = response.headers.get( 'Content-Disposition' );
        if ( contentDisposition ) {
          const match = contentDisposition.match( /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/ );
          if ( match ) {
            lastFileName = match[ 1 ].replace( /['"]/g, '' );
          }
        }

        // Create audio URL and play
        const audioUrl = URL.createObjectURL( blob );
        const audioPlayer = document.getElementById( 'audioPlayer' );
        audioPlayer.src = audioUrl;

        // Show audio output
        document.getElementById( 'audioOutput' ).classList.remove( 'hidden' );

        if ( mode === 'stream' ) {
          audioPlayer.play();
          showStatus( 'Audio generated and playing!', 'success' );
        } else {
          // Trigger download
          const a = document.createElement( 'a' );
          a.href = audioUrl;
          a.download = lastFileName;
          document.body.appendChild( a );
          a.click();
          document.body.removeChild( a );
          showStatus( 'Audio generated and downloaded!', 'success' );
        }

        // Refresh the output audio library
        await loadOutputAudioFiles();

      } catch ( error ) {
        console.error( 'Error generating audio:', error );
        showStatus( `Error: ${error.message}`, 'error' );
      } finally {
        // Re-enable buttons
        document.querySelectorAll( 'button' ).forEach( btn => btn.disabled = false );
      }
    }

    function downloadLastAudio() {
      if ( lastAudioBlob ) {
        const url = URL.createObjectURL( lastAudioBlob );
        const a = document.createElement( 'a' );
        a.href = url;
        a.download = lastFileName;
        document.body.appendChild( a );
        a.click();
        document.body.removeChild( a );
        URL.revokeObjectURL( url );
      }
    }

    // Check API availability on load
    window.addEventListener( 'load', async function () {
      try {
        const response = await fetch( `${API_BASE_URL}/health` );
        if ( response.ok ) {
          showStatus( 'API is ready!', 'success' );
          setTimeout( hideStatus, 3000 );
          // Load reference audio files
          await loadReferenceAudioFiles();
          // Load output audio files
          await loadOutputAudioFiles();
        } else {
          showStatus( 'API is not responding properly.', 'error' );
        }
      } catch ( error ) {
        showStatus( 'Cannot connect to API. Make sure the server is running on http://localhost:8000', 'error' );
      }
    } );

    // Load reference audio files
    async function loadReferenceAudioFiles() {
      try {
        const response = await fetch( `${API_BASE_URL}/reference-audio/list` );
        if ( response.ok ) {
          const data = await response.json();
          const select = document.getElementById( 'existingReference' );
          select.innerHTML = '<option value="">Select a reference audio file...</option>';

          data.reference_files.forEach( file => {
            const option = document.createElement( 'option' );
            option.value = file.filename;
            option.textContent = `${file.filename} (${formatFileSize( file.size )})`;
            select.appendChild( option );
          } );
        }
      } catch ( error ) {
        console.error( 'Error loading reference audio files:', error );
      }
    }

    // Format file size
    function formatFileSize( bytes ) {
      if ( bytes === 0 ) return '0 Bytes';
      const k = 1024;
      const sizes = [ 'Bytes', 'KB', 'MB', 'GB' ];
      const i = Math.floor( Math.log( bytes ) / Math.log( k ) );
      return parseFloat( ( bytes / Math.pow( k, i ) ).toFixed( 2 ) ) + ' ' + sizes[ i ];
    }

    // Upload reference audio
    async function uploadReferenceAudio() {
      const fileInput = document.getElementById( 'referenceAudio' );
      if ( !fileInput.files.length ) {
        showStatus( 'Please select a file to upload first.', 'error' );
        return;
      }

      const formData = new FormData();
      formData.append( 'file', fileInput.files[ 0 ] );

      try {
        showStatus( 'Uploading reference audio...', 'loading' );

        const response = await fetch( `${API_BASE_URL}/reference-audio/upload`, {
          method: 'POST',
          body: formData
        } );

        if ( response.ok ) {
          const result = await response.json();
          showStatus( `Reference audio uploaded successfully as: ${result.filename}`, 'success' );

          // Reload reference audio list
          await loadReferenceAudioFiles();

          // Select the newly uploaded file in the dropdown
          document.getElementById( 'existingReference' ).value = result.filename;

        } else {
          const errorText = await response.text();
          throw new Error( `HTTP ${response.status}: ${errorText}` );
        }
      } catch ( error ) {
        console.error( 'Error uploading reference audio:', error );
        showStatus( `Error uploading reference audio: ${error.message}`, 'error' );
      }
    }

    // Delete reference audio
    async function deleteReferenceAudio() {
      const select = document.getElementById( 'existingReference' );
      const selectedFile = select.value;

      if ( !selectedFile ) {
        showStatus( 'Please select a reference audio file to delete.', 'error' );
        return;
      }

      // Confirm deletion
      if ( !confirm( `Are you sure you want to delete "${selectedFile}"? This action cannot be undone.` ) ) {
        return;
      }

      try {
        showStatus( 'Deleting reference audio...', 'loading' );

        const response = await fetch( `${API_BASE_URL}/reference-audio/delete/${encodeURIComponent( selectedFile )}`, {
          method: 'DELETE'
        } );

        if ( response.ok ) {
          const result = await response.json();
          showStatus( `Reference audio deleted successfully: ${selectedFile}`, 'success' );

          // Reload reference audio list
          await loadReferenceAudioFiles();

          // Clear selection
          select.value = '';

        } else {
          const errorText = await response.text();
          throw new Error( `HTTP ${response.status}: ${errorText}` );
        }
      } catch ( error ) {
        console.error( 'Error deleting reference audio:', error );
        showStatus( `Error deleting reference audio: ${error.message}`, 'error' );
      }
    }

    // Initialize character count
    document.getElementById( 'charCount' ).textContent = document.getElementById( 'text' ).value.length;

    // Load output audio files
    async function loadOutputAudioFiles() {
      try {
        const response = await fetch( `${API_BASE_URL}/output-audio/list` );
        if ( response.ok ) {
          const data = await response.json();
          const container = document.getElementById( 'audioFilesList' );
          const countSpan = document.getElementById( 'audioLibraryCount' );

          countSpan.textContent = `(${data.count} files)`;

          if ( data.count === 0 ) {
            container.innerHTML = '<div class="empty-library">No generated audio files yet. Generate some audio to see them here!</div>';
            return;
          }

          container.innerHTML = '';

          data.output_files.forEach( file => {
            const fileItem = document.createElement( 'div' );
            fileItem.className = 'audio-file-item';

            const fileDate = new Date( file.modified ).toLocaleString();

            fileItem.innerHTML = `
              <div class="audio-file-info">
                <div class="audio-file-name">${file.filename}</div>
                <div class="audio-file-meta">${formatFileSize( file.size )} ‚Ä¢ ${fileDate}</div>
              </div>
              <div class="audio-file-actions">
                <button class="btn-small btn-play" onclick="playOutputAudio('${file.filename}')" title="Play">
                  ‚ñ∂Ô∏è
                </button>
                <button class="btn-small btn-download" onclick="downloadOutputAudio('${file.filename}')" title="Download">
                  üíæ
                </button>
                <button class="btn-small btn-delete" onclick="deleteOutputAudio('${file.filename}')" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            `;

            container.appendChild( fileItem );
          } );
        }
      } catch ( error ) {
        console.error( 'Error loading output audio files:', error );
        document.getElementById( 'audioFilesList' ).innerHTML = '<div class="empty-library">Error loading audio files.</div>';
      }
    }

    // Play output audio file
    async function playOutputAudio( filename ) {
      try {
        const response = await fetch( `${API_BASE_URL}/output-audio/download/${encodeURIComponent( filename )}` );
        if ( response.ok ) {
          const blob = await response.blob();
          const audioUrl = URL.createObjectURL( blob );
          const audioPlayer = document.getElementById( 'audioPlayer' );
          audioPlayer.src = audioUrl;
          audioPlayer.play();

          // Show audio output section
          document.getElementById( 'audioOutput' ).classList.remove( 'hidden' );

          showStatus( `Playing: ${filename}`, 'success' );
          setTimeout( hideStatus, 2000 );
        } else {
          throw new Error( `Failed to load audio file: ${response.statusText}` );
        }
      } catch ( error ) {
        console.error( 'Error playing audio:', error );
        showStatus( `Error playing audio: ${error.message}`, 'error' );
      }
    }

    // Download output audio file
    async function downloadOutputAudio( filename ) {
      try {
        const url = `${API_BASE_URL}/output-audio/download/${encodeURIComponent( filename )}`;
        const a = document.createElement( 'a' );
        a.href = url;
        a.download = filename;
        document.body.appendChild( a );
        a.click();
        document.body.removeChild( a );

        showStatus( `Downloading: ${filename}`, 'success' );
        setTimeout( hideStatus, 2000 );
      } catch ( error ) {
        console.error( 'Error downloading audio:', error );
        showStatus( `Error downloading audio: ${error.message}`, 'error' );
      }
    }

    // Delete output audio file
    async function deleteOutputAudio( filename ) {
      if ( !confirm( `Are you sure you want to delete "${filename}"? This action cannot be undone.` ) ) {
        return;
      }

      try {
        showStatus( 'Deleting audio file...', 'loading' );

        const response = await fetch( `${API_BASE_URL}/output-audio/delete/${encodeURIComponent( filename )}`, {
          method: 'DELETE'
        } );

        if ( response.ok ) {
          showStatus( `Audio file deleted: ${filename}`, 'success' );
          setTimeout( hideStatus, 2000 );

          // Reload output audio list
          await loadOutputAudioFiles();
        } else {
          const errorText = await response.text();
          throw new Error( `HTTP ${response.status}: ${errorText}` );
        }
      } catch ( error ) {
        console.error( 'Error deleting audio file:', error );
        showStatus( `Error deleting audio file: ${error.message}`, 'error' );
      }
    }
  </script>
</body>

</html>